name: 🤖 Dependabot Auto-Approve & Merge

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - labeled

jobs:
  dependabot:
    name: 🤖 Dependabot Auto-Processing
    runs-on: ubuntu-latest
    if: ${{ github.actor == 'dependabot[bot]' }}
    permissions:
      contents: write
      pull-requests: write
      issues: write
      repository-projects: write
      packages: read
    
    steps:
      - name: 👀 Check if PR is from Dependabot
        id: is-dependabot-pr
        run: |
          if [[ "${{ github.actor }}" == "dependabot[bot]" ]]; then
            echo "is_dependabot_pr=true" >> $GITHUB_OUTPUT
          else
            echo "is_dependabot_pr=false" >> $GITHUB_OUTPUT
          fi

      - name: 🔎 Get PR details
        id: pr-details
        if: steps.is-dependabot-pr.outputs.is_dependabot_pr == 'true'
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ "$PR_TITLE" =~ .*security.* || "$PR_TITLE" =~ .*[Ss]ecurity.* ]]; then
            echo "is_security_update=true" >> $GITHUB_OUTPUT
          else
            echo "is_security_update=false" >> $GITHUB_OUTPUT
          fi
          
          if [[ "$PR_TITLE" =~ .*patch.* || "$PR_TITLE" =~ .*[Pp]atch.* ]]; then
            echo "is_patch=true" >> $GITHUB_OUTPUT
          else
            echo "is_patch=false" >> $GITHUB_OUTPUT
          fi

      - name: 🏷️ Apply labels based on PR type
        if: steps.is-dependabot-pr.outputs.is_dependabot_pr == 'true'
        run: |
          if [[ "${{ steps.pr-details.outputs.is_security_update }}" == "true" ]]; then
            echo "Applying security label"
            gh pr edit "${{ github.event.pull_request.number }}" --add-label "security-fix"
          fi
          
          if [[ "${{ steps.pr-details.outputs.is_patch }}" == "true" ]]; then
            echo "Applying patch label"
            gh pr edit "${{ github.event.pull_request.number }}" --add-label "patch"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ✅ Approve PR
        if: steps.is-dependabot-pr.outputs.is_dependabot_pr == 'true'
        run: gh pr review --approve "${{ github.event.pull_request.number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 🔄 Enable auto-merge for security and patch updates
        if: |
          steps.is-dependabot-pr.outputs.is_dependabot_pr == 'true' && 
          (steps.pr-details.outputs.is_security_update == 'true' || steps.pr-details.outputs.is_patch == 'true')
        run: gh pr merge --auto --squash "${{ github.event.pull_request.number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
