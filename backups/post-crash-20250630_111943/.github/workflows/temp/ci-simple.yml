name: CI - Test and Validate

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ develop, feature/* ]
  workflow_dispatch:

jobs:
  validate:
    name: âœ… Validate Static Website
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: âœ… Validate HTML structure
        run: |
          echo "ğŸ” Validating HTML files..."
          if [[ -f "index.html" ]]; then
            echo "âœ… index.html found"
            # Basic HTML validation
            if grep -q "<!DOCTYPE html>" index.html; then
              echo "âœ… DOCTYPE declaration found"
            else
              echo "âš ï¸ Missing DOCTYPE declaration"
            fi
            
            if grep -q "<title>" index.html; then
              echo "âœ… Title tag found"
            else
              echo "âš ï¸ Missing title tag"
            fi
            
            if grep -q "lang=" index.html; then
              echo "âœ… Language attribute found"
            else
              echo "âš ï¸ Missing language attribute"
            fi
          else
            echo "âŒ index.html missing"
            exit 1
          fi
          
      - name: âœ… Validate CSS/JS assets
        run: |
          echo "ğŸ” Checking CSS and JavaScript files..."
          css_count=$(find assets/ -name "*.css" 2>/dev/null | wc -l)
          js_count=$(find assets/ -name "*.js" 2>/dev/null | wc -l)
          
          echo "ğŸ“Š Found $css_count CSS files"
          echo "ğŸ“Š Found $js_count JavaScript files"
          
          if [[ $css_count -gt 0 ]]; then
            echo "âœ… CSS assets found"
            find assets/ -name "*.css" | head -5
          else
            echo "âš ï¸ No CSS files found"
          fi
          
          if [[ $js_count -gt 0 ]]; then
            echo "âœ… JavaScript assets found"
            find assets/ -name "*.js" | head -5
          else
            echo "âš ï¸ No JavaScript files found"
          fi
          
      - name: âœ… Check images and icons
        run: |
          echo "ğŸ” Checking image assets..."
          img_count=$(find assets/ -name "*.webp" -o -name "*.png" -o -name "*.jpg" -o -name "*.ico" 2>/dev/null | wc -l)
          
          echo "ğŸ“Š Found $img_count image files"
          
          if [[ $img_count -gt 0 ]]; then
            echo "âœ… Image assets found"
            find assets/ \( -name "*.webp" -o -name "*.png" -o -name "*.jpg" -o -name "*.ico" \) | head -10
          else
            echo "âš ï¸ No image files found"
          fi
          
      - name: âœ… Validate manifest.json
        run: |
          if [[ -f "manifest.json" ]]; then
            echo "âœ… manifest.json found"
            # Basic JSON validation
            if python3 -m json.tool manifest.json > /dev/null 2>&1; then
              echo "âœ… manifest.json is valid JSON"
            else
              echo "âŒ manifest.json is invalid JSON"
              exit 1
            fi
          else
            echo "âš ï¸ manifest.json not found (PWA functionality may be limited)"
          fi
          
      - name: ğŸ“Š Generate validation report
        run: |
          echo "# ğŸ§ª CI Validation Report" > CI_VALIDATION_REPORT.md
          echo "- Date: $(date)" >> CI_VALIDATION_REPORT.md
          echo "- Branch: ${{ github.ref_name }}" >> CI_VALIDATION_REPORT.md
          echo "- Commit: ${{ github.sha }}" >> CI_VALIDATION_REPORT.md
          echo "- Status: âœ… Static website validation completed" >> CI_VALIDATION_REPORT.md
          echo "" >> CI_VALIDATION_REPORT.md
          echo "## File Structure:" >> CI_VALIDATION_REPORT.md
          echo '```' >> CI_VALIDATION_REPORT.md
          ls -la | grep -E '\.(html|json|css|js|webp|png|ico)$' >> CI_VALIDATION_REPORT.md || echo "No matching files in root"
          echo '```' >> CI_VALIDATION_REPORT.md
          echo "" >> CI_VALIDATION_REPORT.md
          echo "## Assets:" >> CI_VALIDATION_REPORT.md
          echo '```' >> CI_VALIDATION_REPORT.md
          find assets/ -type f 2>/dev/null | head -20 >> CI_VALIDATION_REPORT.md || echo "No assets found"
          echo '```' >> CI_VALIDATION_REPORT.md
