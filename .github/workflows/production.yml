name: ğŸš€ Production Deployment & Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  NODE_VERSION: '20' # Vereinheitlicht auf Node 20
  SMTP_HOST: ${{ secrets.SMTP_HOST }}
  SMTP_PORT: ${{ secrets.SMTP_PORT }}
  SMTP_USER: ${{ secrets.SMTP_USER }}
  SMTP_PASS: ${{ secrets.SMTP_PASS }}
  ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}

jobs:
  build-and-test:
    name: ğŸ—ï¸ Build, Test & Report
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ Install dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Build project
        run: npm run build

      - name: ğŸš€ Start server in background
        run: npm run serve &

      - name: â±ï¸ Wait for server to be ready
        run: npx wait-on http://localhost:8080 -t 60000

      - name: ğŸ›¡ï¸ Run QA, Tests & Reports
        run: |
          set -eo pipefail
          npm run lint:report || true
          npm run test:e2e:ci || true
          npm run lighthouse || true
        
      - name: ğŸ“ Generate Status Page
        if: always()
        run: node tools/generate-status-page.js
        
      - name: ğŸ”’ Security audit
        run: npm audit
        
      - name: ğŸ“Š Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: |
            ./index.html
            ./assets/
            ./_headers
            ./CNAME
            ./404.html
            ./manifest.json
            ./status.html

      - name: ğŸ“¤ Archive QA Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: production-qa-reports
          path: |
            playwright-report/
            .lighthouseci/
            lint-results.json

      - name: ğŸ“§ Send mail on failure
        if: failure()
        run: |
          node -e 'require("./tools/alert-service").sendAlert({ 
            message: "Production Workflow Failed in ${{ github.repository }}", 
            level: "critical", 
            extra: { 
              repository: "${{ github.repository }}", 
              commit: "${{ github.sha }}", 
              workflow: "${{ github.workflow }}" 
            }, 
            email: { 
              to: process.env.ALERT_EMAIL, 
              subject: "âŒ PRODUCTION Workflow Failed: ${{ github.repository }}" 
            } 
          })'

  deploy-gh-pages:
    name: ğŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: write
      
    steps:
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-build
          path: ./
          
      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'ğŸš€ Deploy: ${{ github.sha }}'
