name: ğŸš¨ EMERGENCY DEPLOY - Fix Website Availability

on:
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no changes'
        required: false
        default: 'true'

env:
  NODE_VERSION: '20'
  SITE_URL: 'https://burnitoken.website'

jobs:
  emergency-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš¨ Emergency Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“‹ Debug Repository State
        run: |
          echo "=== EMERGENCY DEPLOYMENT DEBUG ==="
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Working Directory:"
          ls -la
          echo "=== INDEX.HTML CHECK ==="
          if [ -f "index.html" ]; then
            echo "âœ… index.html exists"
            head -10 index.html
          else
            echo "âŒ index.html missing!"
          fi
          echo "=== CNAME CHECK ==="
          if [ -f "CNAME" ]; then
            echo "âœ… CNAME exists:"
            cat CNAME
          else
            echo "âŒ CNAME missing!"
          fi

      - name: ğŸ”§ Prepare Emergency Deployment
        run: |
          echo "Preparing emergency deployment files..."
          mkdir -p emergency-dist

          # Copy critical files
          if [ -f "index.html" ]; then
            cp index.html emergency-dist/
            echo "âœ… index.html copied"
          else
            echo "âŒ CRITICAL: index.html missing!"
            exit 1
          fi

          # Copy assets directory
          if [ -d "assets" ]; then
            cp -r assets emergency-dist/
            echo "âœ… Assets directory copied"
          else
            echo "âš ï¸ Assets directory missing"
          fi

          # Copy all other necessary files
          for file in *.html *.js *.json *.xml *.txt *.css; do
            if [ -f "$file" ]; then
              cp "$file" emergency-dist/
              echo "âœ… Copied $file"
            fi
          done

          # Copy additional directories
          for dir in pages public src; do
            if [ -d "$dir" ]; then
              cp -r "$dir" emergency-dist/
              echo "âœ… Copied $dir directory"
            fi
          done

          echo "=== EMERGENCY DIST CONTENTS ==="
          ls -la emergency-dist/

      - name: ğŸš¨ Emergency Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./emergency-dist
          cname: burnitoken.website
          force_orphan: true
          enable_jekyll: false
          commit_message: 'ğŸš¨ EMERGENCY DEPLOY - Fix Website Availability - ${{ github.sha }}'
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      - name: ğŸ¯ Post-Deployment Verification
        run: |
          echo "=== POST-DEPLOYMENT VERIFICATION ==="
          echo "ğŸŒ Website should be available at: ${{ env.SITE_URL }}"
          echo "â° DNS propagation may take 5-10 minutes"
          echo "ğŸ”„ Testing availability..."

          # Wait a moment and test
          sleep 30

          # Test multiple endpoints
          for url in "https://burnitoken.website" "https://kryptonator.github.io/burnitoken"; do
            echo "Testing $url..."
            if curl -I "$url" 2>/dev/null | head -1 | grep -q "200\|301\|302"; then
              echo "âœ… $url responding"
            else
              echo "âŒ $url not responding"
            fi
          done

      - name: ğŸ“Š Emergency Deployment Summary
        if: always()
        run: |
          echo "================================================"
          echo "ğŸš¨ EMERGENCY DEPLOYMENT COMPLETED!"
          echo "================================================"
          echo "ğŸŒ Website URL: ${{ env.SITE_URL }}"
          echo "ğŸ”„ Status: Emergency deployment executed"
          echo "â° Wait 5-10 minutes for DNS propagation"
          echo "ğŸ” Check GitHub Pages settings if issues persist"
          echo "================================================"
