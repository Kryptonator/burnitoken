require('dotenv').config();
// tools/github-issue-creator.js
/**
 * GitHub Issue Creator
 *
 * Erstellt automatisch ein GitHub Issue bei kritischen Systemfehlern.
 * Verwendet die GitHub API und ben√∂tigt ein GITHUB_TOKEN.
 *
 * Erstellt: 2025-06-25
 */

const https = require('https');

// --- Konfiguration ---
// GitHub Repository (owner/repo)
let GITHUB_REPO = process.env.GITHUB_REPO;
if (!GITHUB_REPO) 
  GITHUB_REPO = 'Kryptonator/burnitoken'; // Fallback
  console.log(
    `‚ö†Ô∏è  Hinweis: GITHUB_REPO ist nicht in der .env-Datei konfiguriert. Es wird der Standardwert '${GITHUB_REPO}' verwendet.`,
  );
}
const GITHUB_OWNER = process.env.GITHUB_OWNER || GITHUB_REPO.split('/')[0];
// GitHub-Token aus den Umgebungsvariablen laden
const GITHUB_TOKEN = process.env.GITHUB_TOKEN;

/**
 * Erstellt ein neues GitHub Issue.
 * @param {string} title - Der Titel des Issues.
 * @param {string} body - Der Inhalt des Issues (Markdown-formatiert).
 * @param {string[]} [labels=[]] - Ein Array von Labels, die dem Issue hinzugef√ºgt werden sollen.
 * @returns {Promise<string>} - Die URL des neu erstellten Issues.
 */
async function createGitHubIssue(title, body, labels = ['bug', 'autogenerated']) {
  if (!GITHUB_TOKEN) {
    const errorMessage =
      'Fehler: GITHUB_TOKEN ist nicht gesetzt. Das Issue kann nicht erstellt werden.';
    console.error(`‚ùå ${errorMessage}`);
    return Promise.reject(new Error(errorMessage));
  }

  const issueData = JSON.stringify({
    title: `ü§ñ [Automatisch gemeldet] ${title}`,
    body: `${body}\n\n---\n*Dieses Issue wurde automatisch vom System-Monitoring erstellt.*`,
    labels: labels,
    assignees: [GITHUB_OWNER],
  });

  const options = {
    hostname: 'api.github.com',
    path: `/repos/${GITHUB_REPO}/issues`,
    method: 'POST',
    headers: {
      Authorization: `token ${GITHUB_TOKEN}`,
      'User-Agent': 'burnitoken-monitoring-service',
      'Content-Type': 'application/json',
      'Content-Length': Buffer.byteLength(issueData, 'utf8'),
    },
  };

  return new Promise((resolve, reject) => {
    console.log(` Issue wird in Repository ${GITHUB_REPO} erstellt...`);

    const req = https.request(options, (res) => {
      let responseBody = '';
      res.on('data', (chunk) => {
        responseBody += chunk;
      });

      res.on('end', () => {
        const response = JSON.parse(responseBody);
        if (res.statusCode >= 200 && res.statusCode < 300) {
          console.log(`‚úÖ GitHub Issue erfolgreich erstellt: ${response.html_url}`);
          resolve(response.html_url);
        } else {
          const errorMessage = `Fehler beim Erstellen des GitHub Issues. Status: ${res.statusCode}, Antwort: ${responseBody}`;
          console.error(`‚ùå ${errorMessage}`);
          reject(new Error(errorMessage));
        }
      });
    });

    req.on('error', (error) => {
      const errorMessage = `Fehler bei der Anfrage an die GitHub API: ${error.message}`;
      console.error(`‚ùå ${errorMessage}`);
      reject(new Error(errorMessage));
    });

    req.write(issueData);
    req.end();
  });
}

module.exports = { createGitHubIssue };
